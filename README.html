<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
lang="en" xml:lang="en">
<head>
<title>FASLPATH</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2009-04-23 18:51:05 EEST"/>
<meta name="author" content="Peter von Etter"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color:lightblue; font-weight:normal }
  .target { }
  .timestamp { color: grey }
  .timestamp-kwd { color: CadetBlue }
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style><style type="text/css">
  html {
	font-family: Times, serif;
	font-size: 12pt;
  }
  body {margin-left: 5em; margin-right: 5em}
 .title { text-align: center; }
  .todo  { color: red; }
  .done { color: green; }
  .timestamp { color: grey }
  .timestamp-kwd { color: CadetBlue }
  .tag { background-color:lightblue; font-weight:normal }
  .target { background-color: lavender; }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
  }
  table { border-collapse: collapse; }
  td, th {
	vertical-align: top;
	<!--border: 1pt solid #ADB9CC;-->
  }
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*/-->
</script>
</head><body>
<h1 class="title">FASLPATH</h1>

<p>An introduction to the Faslpath loader.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction </a></li>
<li><a href="#sec-2">2 Obtaining </a></li>
<li><a href="#sec-3">3 Installation </a></li>
<li><a href="#sec-4">4 Usage </a></li>
<li><a href="#sec-5">5 More details </a></li>
<li><a href="#sec-6">6 Extra features </a></li>
<li><a href="#sec-7">7 Package Interface </a>
<ul>
<li><a href="#sec-7.1">7.1 *FASLPATH* </a></li>
<li><a href="#sec-7.2">7.2 COMPILE-PACKAGE </a></li>
<li><a href="#sec-7.3">7.3 LOAD-PACKAGE </a></li>
<li><a href="#sec-7.4">7.4 COMPILE-PACKAGE-FROM-SCRATCH </a></li>
</ul>
</li>
<li><a href="#sec-8">8 Shell scripts </a>
<ul>
<li><a href="#sec-8.1">8.1 compile-lisp-package </a></li>
<li><a href="#sec-8.2">8.2 make-lisp-core </a></li>
<li><a href="#sec-8.3">8.3 invoke-lisp-package </a></li>
<li><a href="#sec-8.4">8.4 invoke-lisp-core </a></li>
<li><a href="#sec-8.5">8.5 start-lisp-package </a></li>
<li><a href="#sec-8.6">8.6 start-lisp-core </a></li>
</ul>
</li>
<li><a href="#sec-9">9 Supported implementations </a>
<ul>
<li><a href="#sec-9.1">9.1 Porting to other implementations </a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">1 Introduction </h2>
<div id="text-1">


<p>
Faslpath is a build tool for Common Lisp that is intended to be very
easy to use, even for beginner lisp programmers.  It does not require
separate build files.  Instead, it relies on naming conventions to
statically resolve dependencies between files.  An illustrative
example is probably the easiest way to explain how it works.
</p>
<p>
Suppose we have the following directory structure:
</p>
<ul>
<li>
lib
<ul>
<li>
foo
<ul>
<li>
foo.lisp
</li>
<li>
util.lisp
</li>
</ul>
</li>
<li>
bar
<ul>
<li>
bar.lisp
</li>
<li>
macros.lisp
</li>
<li>
util.lisp

</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>and that the files look like this
</p>
<p>
foo/foo.lisp:
</p>
<pre class="example">
 (defpackage :foo.foo
   (:use :cl
         :foo.util
         :bar.bar)
   (:export #:FOO))
 ...
</pre>

<p>
foo/util.lisp:
</p>
<pre class="example">
 (defpackage :foo.util
   (:use :cl)
   (:export #:FOO-TOOL))
 ...

</pre>
bar/bar.lisp:

<pre class="example">
 (defpackage :bar.bar
   (:use :cl
         :bar.macros
         :bar.util)
   (:export #:BAR #:WITH-BAR))
 ...
</pre>

<p>
bar/util.lisp:
</p>
<pre class="example">
 (defpackage :bar.util
   (:use :cl
         :bar.macros)
   (:export #:BAR-TOOL))
 ...
</pre>

<p>
bar/macros.lisp:
</p>
<pre class="example">
 (defpackage :bar.macros
   (:use :cl)
   (:export #:WITH-BAR))
 ...
</pre>

<p>
Now, given these files, we can call
</p>
<pre class="example">
 (faslpath:compile-package :foo.foo)
</pre>

<p>
This will tell the faslpath loader to compile the package :foo.foo.
It will automatically figure out the dependencies of each file and
compile them in the right order.  It does so by examining the
defpackage form in each file and assuming that a package
named :bar.util will be found in the file bar/util.lisp.  The only
configuration that's required is to tell the faslpath loader about the
"lib" directory by pushing #P/path/to/lib/ onto the
faslpath:*faslpath* variable.
</p>

</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">2 Obtaining </h2>
<div id="text-2">


<p>
Faslpath is available at <a href="http://code.google.com/p/faslpath/">http://code.google.com/p/faslpath/</a>
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">3 Installation </h2>
<div id="text-3">


<ol>
<li>
Run the script "compile-IMPL.sh" where IMPL is one of the supported
implementations.  It will compile faslpath and run some tests.  If
you see a stack trace, it probably means that one of the tests
failed, and that the program should not be used.

</li>
<li>
Add the following to your implementation's init file, replacing the
paths appropriately:

<pre class="example">
 (load "/home/john/lisp/faslpath/faslpath.fasl")
 (use-package :faslpath)
 (setf *faslpath* '(#P"/home/john/lisp/"))
</pre>

</li>
<li>
Copy any scripts you want from the "scripts" directory into a
directory such as "~/bin".  They will give you easy access to your
packages.

</li>
</ol>

<p>After these steps, code placed in /home/john/lisp/ and its
subdirectories should be visible to the faslpath loader.
</p>

</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">4 Usage </h2>
<div id="text-4">


<p>
To make use of faslpath, simply name your source files according to
their location and make sure that the first form in each file is a
defpackage form.  Dependencies are specified with the "USE" list in
the defpackage form.
</p>
<p>
Example:
</p>
<p>
In the file my-app/main.lisp you need:
</p>
<pre class="example">
 (defpackage :my-app.main
   (:use :cl
         :my-app.tools
         :my-app.macros
         :my-app.asdf-deps
         :my-external-lib.main)
   (:export #:RUN-MY-APP
            #:MAIN))

 (in-package :my-app.main)

 [ ... Code follows ... ]
</pre>

<p>
Now COMPILE-PACKAGE and LOAD-PACKAGE will know what the symbol
"MY-APP.MAIN" means, and will be able to find it.  One could now, for
instance, run the shell command
</p>
<pre class="example">
$ invoke-lisp-package my-app.main
</pre>

<p>
This would load the MY-APP.MAIN package and its dependencies and then
call the MAIN function in that package.
</p>

</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">5 More details </h2>
<div id="text-5">


<p>
Dependencies are extracted directly from the source files by mapping
package names to source files.  This enables us to "overload" the use
list in defpackage to indicate file dependencies in addition to normal
package dependencies.  Currently, the mapping from packages to source
files used is the familiar "dotted" notation, i.e. a package named
"FOO.BAR.QWE" represents the relative pathname "foo/bar/qwe.lisp".
</p>
<p>
The faslpath loader determines the dependencies of a lisp file by
probing the file for a defpackage form and resolving the packages in
the use list according to the package-&gt;file mapping used.  The probing
is done by READing the first form in the file.  As a result of this,
the file does not get loaded.
</p>
<p>
In order for all of this to work we need to adopt a couple of
conventions:
</p>
<ul>
<li>
The name of a package should match the location of the source file.
In other words, the file "foo/bar/qwe.lisp" should contain a
defpackage form that defines a package named "FOO.BAR.QWE".

</li>
<li>
All dependencies should be specified in the defpackage use list.

</li>
<li>
The defpackage form should be the *first* form in the file.
Alternatively, a quoted list such as '(:foo.util :bar.bar) can be
used as the first form to specify dependencies, but this isn't
encouraged.

</li>
</ul>

<p>The faslpath:*faslpath* variable should contain a list of directory pathnames
that should be searched when resolving dependencies.  It is probably
best to do set this this in the lisp init file, like this, for
example:
</p>
<pre class="example">
 (load "/path/to/faslpath.fasl")
 (use-package :faslpath)
 (setf *faslpath* '(#P/path/to/my/libs/
                    #P/path/to/some/other/libs/))
</pre>


</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">6 Extra features </h2>
<div id="text-6">


<p>
If you absolutely do not want to have a defpackage in each file, or if
you need finer control over which symbols are imported into in a
package, then you can specify dependencies with a quoted list as the
first form in a file.  This is a somewhat ugly hack, and may change in
the future.
</p>
<p>
Symbols in the quoted list will be interpreted as package
dependencies.  They will be searched for in faslpath:*faslpath* and
loaded if necessary.  Note that a package is considered "loaded" if
(find-package &hellip;) returns non-nil.
</p>
<p>
Strings in the quoted list will be interpreted as files, relative to
the current file, which will need to be loaded (or compiled) before
the current file is loaded.  The files are assumed to belong to the
same "unit" as the current file and will be loaded unconditionally if
the current file ever becomes loaded.
</p>

<p>
Example:
</p>
<pre class="example">
 '(:my-app.tools
   :my-app.macros
   :my-app.asdf-deps
   :my-external-lib.main
   "file-1"
   "file-2"
   "subdir/file-3"
   "subdir/file-4")

 (in-package :my-app.main)

 [ ... Code follows ... ]
</pre>

</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7">7 Package Interface </h2>
<div id="text-7">


<p>
The following symbols are exported by the FASLPATH package:
</p>

</div>

<div id="outline-container-7.1" class="outline-3">
<h3 id="sec-7.1">7.1 *FASLPATH* </h3>
<div id="text-7.1">


<p>
<em>(special variable)</em>
</p>
<p>
A list of directory pathnames that indicates where the root package
directories are located.
</p>

</div>

</div>

<div id="outline-container-7.2" class="outline-3">
<h3 id="sec-7.2">7.2 COMPILE-PACKAGE </h3>
<div id="text-7.2">


<p>
<em>(function)</em>
</p>
<p>
:COMPILE-PACKAGE PACKAGE-SYMBOL &amp;OPTIONAL TABULA-RASA MAKE-LOADER
</p>
<p>
Compiles and loads the package PACKAGE-SYMBOL along with its
dependencies.  If a file doesn't need to be compiled, then it will
only be loaded.
</p>
<p>
If MAKE-LOADER is t then a package loader will be
generated.  The name of the loader file is of the form
"foo-loader.lisp", assuming PACKAGE-SYMBOL ends with "FOO".
</p>
<p>
If TABULA-RASA is t then any package compiled or loaded will be cleared
of all symbols, as if the package had just been created.
</p>
<p>
Example:
</p><pre class="example">
 (compile-package :my-app.main)
</pre>

<p>
This will make faslpath look for the file "my-app/main.lisp" in the
directories specified by faslpath:*faslpath* and compile it and its
dependencies.
</p>
</div>

</div>

<div id="outline-container-7.3" class="outline-3">
<h3 id="sec-7.3">7.3 LOAD-PACKAGE </h3>
<div id="text-7.3">


<p>
<em>(function)</em>
</p>
<p>
:LOAD-PACKAGE PACKAGE-SYMBOL &amp;OPTIONAL TABULA-RASA FORCE
</p>
<p>
Loads the package PACKAGE-SYMBOL along with its dependencies if it
doesn't already exist.  If a package loader is found, it will be
used to avoid computing dependencies.  If TABULA-RASA is t, then the
package loader will be ignored and any package loaded will be
cleared of all symbols, as if the package had just been created.  If
FORCE is t, then the package will be loaded even if it already
exists.  TABULA-RASA = t implies FORCE = t.
</p>
<p>
Example:
</p><pre class="example">
 (load-package :my-app.main)
</pre>

<p>
This will make faslpath look for the file "my-app/main-loader.fasl"
in the directories specified by faslpath:*faslpath* and load it.  If
the file isn't found, then a dependency tree for the file
"my-app/main.lisp" will be constructed and used to load the required
fasl files.  No files will be recompiled as a result of calling
LOAD-PACKAGE.
</p>

</div>

</div>

<div id="outline-container-7.4" class="outline-3">
<h3 id="sec-7.4">7.4 COMPILE-PACKAGE-FROM-SCRATCH </h3>
<div id="text-7.4">


<p>
<em>(function)</em>
</p>
<p>
:COMPILE-PACKAGE-FROM-SCRATCH PACKAGE-SYMBOL &amp;OPTIONAL TABULA-RASA
</p>
<p>
Unconditionally compiles and loads PACKAGE-SYMBOL and all of its
dependencies.
</p>
</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8">8 Shell scripts </h2>
<div id="text-8">


<p>
A number of shell scripts are provided for convenience
</p>

</div>

<div id="outline-container-8.1" class="outline-3">
<h3 id="sec-8.1">8.1 compile-lisp-package </h3>
<div id="text-8.1">

<p>:compile-lisp-package PACKAGE-NAME
</p>
<p>
Compiles the package named PACKAGE-NAME, then exits.
</p>
<p>
Example:
</p><pre class="example">
$ compile-lisp-package my-app.main
</pre>

</div>

</div>

<div id="outline-container-8.2" class="outline-3">
<h3 id="sec-8.2">8.2 make-lisp-core </h3>
<div id="text-8.2">

<p>:make-lisp-core PACKAGE-NAME
</p>
<p>
Loads the package named PACKAGE-NAME and saves the running lisp
image.
</p>
<p>
Note: This script requires that faslpath can find its own
directory.
</p>
</div>

</div>

<div id="outline-container-8.3" class="outline-3">
<h3 id="sec-8.3">8.3 invoke-lisp-package </h3>
<div id="text-8.3">

<p>:invoke-lisp-package PACKAGE-NAME
</p>
<p>
Loads the package named PACKAGE-NAME and calls the function in that
package specified by the symbol MAIN, then exits.
</p>

</div>

</div>

<div id="outline-container-8.4" class="outline-3">
<h3 id="sec-8.4">8.4 invoke-lisp-core </h3>
<div id="text-8.4">

<p>:invoke-lisp-core PACKAGE-NAME
</p>
<p>
Starts the core named PACKAGE-NAME and calls the function in that
package specified by the symbol MAIN, then exits.
</p>

</div>

</div>

<div id="outline-container-8.5" class="outline-3">
<h3 id="sec-8.5">8.5 start-lisp-package </h3>
<div id="text-8.5">

<p>:start-lisp-package PACKAGE-NAME
</p>
<p>
Starts a lisp and loads the package named PACKAGE-NAME.
</p>

</div>

</div>

<div id="outline-container-8.6" class="outline-3">
<h3 id="sec-8.6">8.6 start-lisp-core </h3>
<div id="text-8.6">

<p>:start-lisp-core PACKAGE-NAME
</p>
<p>
Starts the core named PACKAGE-NAME.
</p>
<p>
These scripts will give easy access to the lisp packages assuming
faslpath is loaded by the lisp init file (or otherwise present in the
running core).
</p>

</div>
</div>

</div>

<div id="outline-container-9" class="outline-2">
<h2 id="sec-9">9 Supported implementations </h2>
<div id="text-9">


<p>
Currently the following implementations have been tested:
</p>
<ul>
<li>
SBCL 1.0.9, 1.0.19 and 1.0.22
</li>
<li>
CLISP 2.42
</li>
<li>
CCL 1.3 (tested on OS X 10.5.6)

</li>
</ul>

</div>

<div id="outline-container-9.1" class="outline-3">
<h3 id="sec-9.1">9.1 Porting to other implementations </h3>
<div id="text-9.1">


<p>
Faslpath should be easily portable to other implementations.
</p>
<p>
In order to port it to another implementation the following is
currently needed:
</p>
<ol>
<li>
Fill in the blanks in impl.lisp and at the beginning
of loader.lisp
</li>
<li>
Port the shell scripts in the scripts directory
</li>
<li>
Create a compile-IMPL.sh script


<hr/>


</li>
</ol>
</div>
</div>
</div>
<div id="postamble"><p class="author"> Author: Peter von Etter
<a href="mailto:peterve@gmail.com">&lt;peterve@gmail.com&gt;</a>
</p>
<p class="date"> Date: 2009-04-23 18:51:05 EEST</p>
<p>HTML generated by org-mode 6.21b in emacs 23</p>
</div></body>
</html>
